<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Documentation - Source: common/FreesoundQuery.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/overrides.css">
</head>

<body>

<div id="main">

    <!-- if home page assume a title is already present in README -->
    
    <h1 class="page-title">Source: common/FreesoundQuery.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { universalXMLHttpRequest } from './util';

/**
 * Class performing generic queries from search terms, usernames and duration information.
 */
class FreesoundQuery {

  /**
   * @param {String} apiKey - Your api key, as generated from your freesound
   * developer account when creating a new application.
   */
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.sndsInfo = new Map();
    this.currentSndsInfo = new Map();

    this._getSoundUrlsFromIds = this._getSoundUrlsFromIds.bind(this);
  }

  /**
   * @param {Object} queryParams - The parameters used to build the query.
   * @param {Array.String} [queryParams.search] - The search terms that will be used to build the query.
   * @param {Array.String} [queryParams.username] - A list of usernames to search files from.
   * @param {Array} [queryParams.duration] - An array of size 2 : [ minDuration, maxDuration ] (in seconds).
   * If maxDuration is not a number, it will be interpreted as "*" (no maximum duration).
   *
   * @returns {Promise} - Promise object will resolve with an array of the sound ids from the api's response to the query.
   *
   * @throws Will throw an error if a problem occurs during query.
   *
   * @todo
   * - add an option to change "page_size" default value (15)
   * - add an option to change "sort" default value ("score")
   * - add an option to filter using geotagging
   */
  query(queryParams) {
    return this._getSoundListFromParameters(queryParams)
      .then(this._getSoundUrlsFromIds)
  }

  /**
   * @private
   * @todo allow to choose between OR and AND to combine usernames in the query.
   */
  _getSoundListFromParameters(params, clear = false) {
    return new Promise((resolve, reject) => {
      if (clear) this.sndsInfo.clear();

      let query = 'http://freesound.org/apiv2/search/text/?';
      const suffix = `&amp;token=${this.apiKey}`;

      if (Object.keys(params).length > 0) {

        if (params.search &amp;&amp; Array.isArray(params.search) &amp;&amp; params.search.length > 0) {
          query += `query=\"${params.search[0]}\"`;

          for (let i = 1; i &lt; params.search.length; i++)
            if (params.search[i] !== '')
              query += ` \"${params.search[i]}\"`;

          query += '&amp;';
        }

        query += 'filter=';

        if (params.duration &amp;&amp; Array.isArray(params.duration) &amp;&amp; params.duration.length === 2 &amp;&amp;
            !isNaN(parseFloat(params.duration[0])) &amp;&amp; isFinite(params.duration[0])) {
          query += `duration:[${params.duration[0]} TO `;

          if (!isNaN(parseFloat(params.duration[1])) &amp;&amp; isFinite(params.duration[1]))
            query += `${params.duration[1]}] `;
          else // === '*'
            query += '*';
        }

        const options = {
          // search:   [ 'query',    'OR' ],
          users:    [ 'username', 'OR' ],
          packs:    [ 'pack',     'OR' ],
        };

        for (let l in options)
          if (params[l] &amp;&amp; Array.isArray(params[l]) &amp;&amp; params[l].length > 0) {
            query += `${options[l][0]}:(${params[l][0]}`;

            for (let i = 1; i &lt; params[l].length; i++)
              if (params[l][i] !== '')
                query += ` ${options[l][1]} ${params[l][i]}`;

            query += ') ';
          }
      }

      query = query.trim();
      query += suffix;

      universalXMLHttpRequest(query)
        .then(response => {
            const res = response.results;

            for (let r in res)
              if (!this.sndsInfo.has(res[r]['id']))
                this.sndsInfo.set(res[r]['id'], res[r]);

            resolve();
        })
        .catch(error => console.error(error.stack));
    });
  }

  /** @private */
  _getSoundUrlsFromIds() {
    this.currentSndsInfo.clear();
    const promises = [];

    for (let id of this.sndsInfo.keys())
      if (!this.sndsInfo.get(id).previews) // detailed information was never queried
        // console.log('pushing promise for id ' + id);
        promises.push(this._getSoundUrlFromId(id));
      else
        this.currentSndsInfo.set(id, this.sndsInfo.get(id));

    return Promise.all(promises);
  }

  /** @private */
  _getSoundUrlFromId(id) {
    return new Promise((resolve, reject) => {
      // DOES THIS PREVENT OTHER FIELDS THAN "preview" TO BE RETURNED ?
      // let query = `http://www.freesound.org/apiv2/sounds/${id}/?filter=preview`;
      let query = `http://www.freesound.org/apiv2/sounds/${id}/?`;
      const suffix = `&amp;token=${this.apiKey}`;
      query += suffix;

      universalXMLHttpRequest(query)
        .then(response => {
            this.sndsInfo.set(id, response);
            this.currentSndsInfo.set(id, this.sndsInfo.get(id));
            // this.sndsInfo.get(id).detailed = JSON.parse(xhr.responseText);

            resolve(id);
        })
        .catch(error => console.error(error.stack));
    });
  }
};

export default FreesoundQuery;

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="FreesoundQuery.html">FreesoundQuery</a></li><li><a href="SimpleFreesound.html">SimpleFreesound</a></li></ul>
</nav>

<br class="clear">

<footer>
    
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Sep 27 2017 03:12:36 GMT+0530 (IST)
    
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
